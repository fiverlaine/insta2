<script>
    window.pixelId = "69858677bf4a78e65736c8b0";
    var a = document.createElement("script");
    a.setAttribute("async", "");
    a.setAttribute("defer", "");
    a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
    document.head.appendChild(a);
</script>

<script src="https://betia.io/betlionscript.js" defer></script>

<!-- TrackTelegram Integration (Keep as is) -->
<script>
    (function () {
        'use strict';
        const TRACKING_API = 'https://tracktelegram.vercel.app/api/bet/identify';
        const STORAGE_PREFIX = 'bet_track_';
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || '';
        }
        function saveToStorage(key, value) {
            try { if (value) localStorage.setItem(STORAGE_PREFIX + key, value); } catch (e) { }
        }
        function getFromStorage(key) {
            try { return localStorage.getItem(STORAGE_PREFIX + key) || ''; } catch (e) { return ''; }
        }
        function getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }
        function generateFbc() {
            const storedFbc = getFromStorage('fbc');
            if (storedFbc) return storedFbc;
            const urlFbc = getUrlParam('fbc');
            if (urlFbc) return urlFbc;
            const cookieFbc = getCookie('_fbc');
            if (cookieFbc) return cookieFbc;
            const fbclid = getUrlParam('fbclid');
            if (fbclid) {
                const timestamp = Date.now();
                return `fb.1.${timestamp}.${fbclid}`;
            }
            return null;
        }
        function generateFingerprint() {
            const components = [navigator.userAgent || '', screen.width + 'x' + screen.height, navigator.language || '', navigator.platform || ''];
            const fingerprintString = components.join('|');
            let hash = 0;
            for (let i = 0; i < fingerprintString.length; i++) {
                hash = ((hash << 5) - hash) + fingerprintString.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }
        function captureUrlParams() {
            const params = ['vid', 'fbc', 'fbp', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'funnel_id'];
            params.forEach(param => {
                const value = getUrlParam(param);
                if (value) saveToStorage(param, value);
            });
        }
        function getTrackingData() {
            return {
                visitor_id: getFromStorage('vid') || getUrlParam('vid'),
                fbc: generateFbc(),
                fbp: getFromStorage('fbp') || getUrlParam('fbp') || getCookie('_fbp'),
                utm_source: getFromStorage('utm_source') || getUrlParam('utm_source'),
                utm_medium: getFromStorage('utm_medium') || getUrlParam('utm_medium'),
                utm_campaign: getFromStorage('utm_campaign') || getUrlParam('utm_campaign'),
                utm_content: getFromStorage('utm_content') || getUrlParam('utm_content'),
                utm_term: getFromStorage('utm_term') || getUrlParam('utm_term'),
                funnel_id: getFromStorage('funnel_id') || getUrlParam('funnel_id'),
                fingerprint: generateFingerprint(),
                user_agent: navigator.userAgent
            };
        }
        function sendIdentification(email, phone) {
            const payload = { email, phone: phone || '', ...getTrackingData() };
            fetch(TRACKING_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                keepalive: true
            }).catch(() => { });
        }
        function setupCadastroListener() {
            const trySetup = () => {
                const btn = document.querySelector('#criar-conta');
                if (btn && !btn._betTrackerAttached) {
                    btn._betTrackerAttached = true;
                    btn.addEventListener('click', function () {
                        const email = document.querySelector('#email_cadastro')?.value;
                        const phone = document.querySelector('#telefone')?.value;
                        if (email) sendIdentification(email, phone);
                    }, true);
                }
            };
            trySetup();
            new MutationObserver(trySetup).observe(document.body, { childList: true, subtree: true });
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', setupCadastroListener);
        else setupCadastroListener();
        captureUrlParams();
    })();
</script>
<!-- UTMify & Supabase Integration (Exclusive for utmify parameter) -->
<script>
    (function () {
        'use strict';
        const SUPABASE_WEBHOOK = 'https://izuspwvgvozwdjzbrpvt.supabase.co/functions/v1/bet-webhook';
        const UTMIFY_FLAG = 'utmify';

        // Helper: Get parameter from URL or Storage
        function getParam(name) {
            return new URLSearchParams(window.location.search).get(name) || localStorage.getItem('utmify_' + name) || '';
        }

        // Helper: Save to Storage with UTMify prefix
        function saveParam(name, value) {
            if (value) localStorage.setItem('utmify_' + name, value);
        }

        // Check if user is tracked by UTMify
        const utmifyValue = getParam(UTMIFY_FLAG);
        if (!utmifyValue) return; // Exit if NOT a utmify lead

        console.log('[UTMifyTrack] Active for lead:', utmifyValue);
        saveParam(UTMIFY_FLAG, utmifyValue);

        // Persistent Lead State
        let currentLead = {
            email: '',
            phone: '',
            cpf: '',
            amount: 0,
            txid: ''
        };

        // Capture UTMs
        const utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'src', 'sck', 'vid'];
        utmParams.forEach(p => saveParam(p, new URLSearchParams(window.location.search).get(p)));

        // =========================================================
        // READ UTMify PIXEL DATA from localStorage
        // The UTMify pixel.js stores lead data under key "lead"
        // It contains: fbp, fbc, ip, geolocation, email, phone, etc.
        // =========================================================
        function getUtmifyLeadData() {
            try {
                const raw = localStorage.getItem('lead');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    return parsed || {};
                }
            } catch (e) {
                console.warn('[UTMifyTrack] Error reading UTMify lead data:', e);
            }
            return {};
        }

        function getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        function getFullPayload(event, extraData = {}) {
            const params = {};
            utmParams.forEach(p => params[p] = getParam(p));

            // Read UTMify pixel's lead data from localStorage
            const utmifyLead = getUtmifyLeadData();

            // Build comprehensive payload with UTMify data
            return {
                event: event,
                data: {
                    ...currentLead,
                    ...params,
                    utmify: utmifyValue,
                    utmify_param: utmifyValue,
                    // Data from UTMify pixel (priority) with fallbacks
                    fbc: utmifyLead.fbc || getCookie('_fbc') || '',
                    fbp: utmifyLead.fbp || getCookie('_fbp') || '',
                    ip: utmifyLead.ip || '',
                    ip_address: utmifyLead.ip || '',
                    user_agent: utmifyLead.userAgent || navigator.userAgent,
                    // Geolocation from UTMify pixel
                    city: (utmifyLead.geolocation && utmifyLead.geolocation.city) || '',
                    state: (utmifyLead.geolocation && utmifyLead.geolocation.state) || '',
                    country: (utmifyLead.geolocation && utmifyLead.geolocation.country) || '',
                    postal_code: (utmifyLead.geolocation && utmifyLead.geolocation.zipcode) || '',
                    // UTMify lead identifiers
                    external_id: utmifyLead._id || '',
                    // Names from UTMify lead
                    first_name: utmifyLead.firstName || '',
                    last_name: utmifyLead.lastName || '',
                    name: [utmifyLead.firstName || '', utmifyLead.lastName || ''].filter(Boolean).join(' ') || currentLead.name || 'Cliente',
                    // Fingerprint
                    fingerprint: (function () {
                        const s = [navigator.userAgent, screen.width + 'x' + screen.height, navigator.language].join('|');
                        let h = 0; for (let i = 0; i < s.length; i++) h = ((h << 5) - h) + s.charCodeAt(i);
                        return Math.abs(h).toString(36);
                    })(),
                    ...extraData
                }
            };
        }

        async function sendToWebhook(payload) {
            console.log('[UTMifyTrack] Sending:', payload.event, payload.data);
            try {
                const resp = await fetch(SUPABASE_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    keepalive: true
                });
                const result = await resp.json();
                console.log('[UTMifyTrack] Response:', result);
            } catch (e) {
                console.error('[UTMifyTrack] Error:', e);
            }
        }

        // 1. Intercept Signup
        function setupSignupWatcher() {
            const trySetup = () => {
                const btn = document.querySelector('#criar-conta');
                if (btn && !btn._utmifyAttached) {
                    btn._utmifyAttached = true;
                    btn.addEventListener('click', function () {
                        currentLead.email = document.querySelector('#email_cadastro')?.value || '';
                        currentLead.phone = document.querySelector('#telefone')?.value || '';
                        currentLead.cpf = document.querySelector('#cpf_cadastro')?.value || '';

                        // Save to persistent storage for later steps
                        saveParam('email', currentLead.email);
                        saveParam('phone', currentLead.phone);
                        saveParam('cpf', currentLead.cpf);

                        if (currentLead.email) {
                            sendToWebhook(getFullPayload('signup'));
                        }
                    }, true);
                }
            };
            trySetup();
            const observer = new MutationObserver(trySetup);
            if (document.body) observer.observe(document.body, { childList: true, subtree: true });
        }

        // 2. Intercept PIX Generation and Payment confirmation via XHR/Fetch monkey-patching
        function patchNetwork() {
            // Restore lead data from storage
            currentLead.email = getParam('email');
            currentLead.phone = getParam('phone');
            currentLead.cpf = getParam('cpf');

            const originalFetch = window.fetch;
            window.fetch = async function (...args) {
                const url = args[0] instanceof URL ? args[0].href : args[0];
                const res = await originalFetch.apply(this, args);

                if (url.includes('gerar_pix')) {
                    const clone = res.clone();
                    try {
                        const data = await clone.json();
                        if (data.success) {
                            console.log('[UTMifyTrack] PIX Generated:', data.valor);
                            currentLead.amount = data.valor;
                            currentLead.txid = data.qrcode ? data.qrcode.split('/').pop() : 'tx_' + Date.now();

                            const txidMatch = data.qrcode?.match(/cob\/([^\/\s?]+)/);
                            if (txidMatch) currentLead.txid = txidMatch[1];

                            saveParam('amount', currentLead.amount);
                            saveParam('txid', currentLead.txid);

                            // Save the creation timestamp for consistent createdAt on paid event
                            const createdAtUTC = new Date().toISOString().replace('T', ' ').split('.')[0];
                            saveParam('pix_created_at', createdAtUTC);

                            sendToWebhook(getFullPayload('pix_generated', { pix_created_at: createdAtUTC }));
                        }
                    } catch (e) { }
                }

                if (url.includes('verifica_pagamento')) {
                    const clone = res.clone();
                    try {
                        const data = await clone.json();
                        if (data.hasUpdate === true) {
                            console.log('[UTMifyTrack] Payment Confirmed!');
                            currentLead.amount = getParam('amount');
                            currentLead.txid = getParam('txid');

                            // Retrieve original createdAt from storage
                            const originalCreatedAt = getParam('pix_created_at');

                            sendToWebhook(getFullPayload('pix_paid', { pix_created_at: originalCreatedAt }));
                        }
                    } catch (e) { }
                }

                return res;
            };
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupSignupWatcher();
                patchNetwork();
            });
        } else {
            setupSignupWatcher();
            patchNetwork();
        }
    })();
</script>