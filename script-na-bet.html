<script>
    (function () {
        'use strict';

        // ===============================================
        // TRACKER 1: ORIGINAL (Telegram/Bet)
        // ===============================================
        (function () {
            const TRACKING_API = 'https://tracktelegram.vercel.app/api/bet/identify';
            const STORAGE_PREFIX = 'bet_track_';

            function getUrlParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name) || '';
            }
            function saveToStorage(key, value) { try { if (value) localStorage.setItem(STORAGE_PREFIX + key, value); } catch (e) { } }
            function getFromStorage(key) { try { return localStorage.getItem(STORAGE_PREFIX + key) || ''; } catch (e) { return ''; } }
            function getCookie(name) { var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)'); return v ? v[2] : null; }

            function generateFbc() {
                const storedFbc = getFromStorage('fbc'); if (storedFbc) return storedFbc;
                const urlFbc = getUrlParam('fbc'); if (urlFbc) return urlFbc;
                const cookieFbc = getCookie('_fbc'); if (cookieFbc) return cookieFbc;
                const fbclid = getUrlParam('fbclid');
                if (fbclid) { const timestamp = Date.now(); return `fb.1.${timestamp}.${fbclid}`; }
                return null;
            }

            function generateFingerprint() {
                const components = [navigator.userAgent || '', screen.width + 'x' + screen.height, navigator.language || '', navigator.platform || ''];
                const str = components.join('|');
                let hash = 0;
                for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; }
                return Math.abs(hash).toString(36);
            }

            function captureUrlParams() {
                const params = ['vid', 'fbc', 'fbp', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'funnel_id', 'fp', 'ua', 'sr', 'tz', 'lang'];
                params.forEach(param => { const value = getUrlParam(param); if (value) saveToStorage(param, value); });
            }

            function getTrackingData() {
                const cookieFbp = getCookie('_fbp');
                return {
                    visitor_id: getFromStorage('vid') || getUrlParam('vid') || generateFingerprint(),
                    fbc: generateFbc(),
                    fbp: getFromStorage('fbp') || getUrlParam('fbp') || cookieFbp,
                    utm_source: getFromStorage('utm_source') || getUrlParam('utm_source'),
                    utm_medium: getFromStorage('utm_medium') || getUrlParam('utm_medium'),
                    utm_campaign: getFromStorage('utm_campaign') || getUrlParam('utm_campaign'),
                    utm_content: getFromStorage('utm_content') || getUrlParam('utm_content'),
                    utm_term: getFromStorage('utm_term') || getUrlParam('utm_term'),
                    funnel_id: getFromStorage('funnel_id') || getUrlParam('funnel_id'),
                    fingerprint: getFromStorage('fp') || getUrlParam('fp') || generateFingerprint(),
                    user_agent: navigator.userAgent
                };
            }

            function sendIdentification(email, phone) {
                const payload = { email: email, phone: phone || '', ...getTrackingData() };
                fetch(TRACKING_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), keepalive: true })
                    .catch(e => console.error('[BetTracker Orig] Erro:', e));
            }

            function setupCadastroListener() {
                function trySetup() {
                    const btnCadastro = document.querySelector('#criar-conta');
                    if (btnCadastro && !btnCadastro._betTrackerOrigAttached) {
                        btnCadastro._betTrackerOrigAttached = true;
                        btnCadastro.addEventListener('click', function () {
                            const email = document.querySelector('#email_cadastro')?.value;
                            const phone = document.querySelector('#telefone')?.value;
                            if (email) sendIdentification(email, phone);
                        }, true);
                    }
                }
                setInterval(trySetup, 2000);
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => { captureUrlParams(); setupCadastroListener(); });
            else { captureUrlParams(); setupCadastroListener(); }
        })();

        // ===============================================
        // TRACKER 2: UTMIFY/SUPABASE (Novo - Condicional)
        // ===============================================
        (function () {
            const SUPABASE_API = 'https://izuspwvgvozwdjzbrpvt.supabase.co/functions/v1/bet-webhook';
            const UTMIFY_PARAM = 'utmify'; // ParÃ¢metro ativador
            const STORAGE_KEY = 'utmify_active_param';

            // Verifica se deve ativar (URL atual ou salvo anteriormente)
            function shouldActivate() {
                const urlParams = new URLSearchParams(window.location.search);
                const initialParam = urlParams.get(UTMIFY_PARAM);
                if (initialParam) {
                    localStorage.setItem(STORAGE_KEY, initialParam);
                    return true;
                }
                return !!localStorage.getItem(STORAGE_KEY);
            }

            if (!shouldActivate()) {
                console.log('[UtmifyTracker] Inativo (Parametro ausente)');
                return;
            }

            console.log('[UtmifyTracker] Ativo e rodando em paralelo');

            function getTrackingData() {
                const p = (k) => localStorage.getItem('bet_track_' + k) || new URLSearchParams(window.location.search).get(k) || '';
                return {
                    utmify_param: localStorage.getItem(STORAGE_KEY),
                    visitor_id: p('vid'), fbc: p('fbc'), fbp: p('fbp'),
                    utm_source: p('utm_source'), utm_medium: p('utm_medium'), utm_campaign: p('utm_campaign'),
                    utm_content: p('utm_content'), utm_term: p('utm_term'),
                    src: p('src'), sck: p('sck'),
                    fingerprint: p('fp'),
                    user_agent: navigator.userAgent
                };
            }

            function sendEvent(eventName, eventData) {
                const payload = { event: eventName, data: { ...getTrackingData(), ...eventData } };
                console.log(`[UtmifyTracker] Enviando ${eventName}`, payload);
                fetch(SUPABASE_API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), keepalive: true })
                    .catch(err => console.error('[UtmifyTracker] Erro:', err));
            }

            // Interceptadores de Rede (Somente se ativo)
            function setupNetworkInterceptors() {
                const originalFetch = window.fetch;
                window.fetch = async function (...args) {
                    const response = await originalFetch.apply(this, args);
                    try {
                        const url = args[0].toString();
                        const clone = response.clone();
                        clone.json().then(data => {
                            if (url.includes('gerar_pix') && data.success) sendEvent('pix_generated', { amount: data.valor || 0, txid: data.qrcode, raw: data });
                            if (url.includes('verifica_pagamento') && data.hasUpdate) sendEvent('pix_paid', { status: 'paid', raw: data });
                        }).catch(() => { });
                    } catch (e) { }
                    return response;
                };

                const originalOpen = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function (method, url) { this._url = url; return originalOpen.apply(this, arguments); };
                const originalSend = XMLHttpRequest.prototype.send;
                XMLHttpRequest.prototype.send = function () {
                    this.addEventListener('load', function () {
                        try {
                            if (this._url && (this._url.includes('gerar_pix') || this._url.includes('verifica_pagamento'))) {
                                const data = JSON.parse(this.responseText);
                                if (this._url.includes('gerar_pix') && data.success) {
                                    let amt = data.valor || parseFloat(document.querySelector('#valuedeposit')?.value || 0);
                                    sendEvent('pix_generated', { amount: amt, txid: data.qrcode, raw: data });
                                }
                                if (this._url.includes('verifica_pagamento') && data.hasUpdate) sendEvent('pix_paid', { status: 'paid', raw: data });
                            }
                        } catch (e) { }
                    });
                    return originalSend.apply(this, arguments);
                };
            }

            function setupCadastro() {
                setInterval(() => {
                    const btn = document.querySelector('#criar-conta');
                    if (btn && !btn._utmifyAttached) {
                        btn._utmifyAttached = true;
                        btn.addEventListener('click', () => {
                            const email = document.querySelector('#email_cadastro')?.value;
                            const phone = document.querySelector('#telefone')?.value;
                            const cpf = document.querySelector('#cpf_cadastro')?.value;
                            if (email) sendEvent('signup', { email, phone, cpf });
                        }, true);
                    }
                }, 2000);
            }

            setupNetworkInterceptors();
            setupCadastro();
        })();

    })();
</script>